<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="BillMaster Pro - Products Management" />
    <title>Products | BillMaster Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/layout.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="app-layout">
      <div class="mobile-overlay"></div>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo"><i data-lucide="briefcase"></i></div>
          <div class="sidebar-brand">
            <h1>BillMaster</h1>
            <span>Pro Billing</span>
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">Menu</div>
            <a href="dashboard.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="layout-dashboard" class="icon"></i
              ></span>
              <span class="nav-item-text">Dashboard</span>
            </a>
            <a href="billing.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="receipt" class="icon"></i
              ></span>
              <span class="nav-item-text">New Bill</span>
            </a>
            <a href="invoices.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="file-text" class="icon"></i
              ></span>
              <span class="nav-item-text">Invoices</span>
            </a>
            <a href="expenses.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="credit-card" class="icon"></i
              ></span>
              <span class="nav-item-text">Expenses</span>
            </a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">Manage</div>
            <a href="products.html" class="nav-item active">
              <span class="nav-item-icon"
                ><i data-lucide="package" class="icon"></i
              ></span>
              <span class="nav-item-text">Products</span>
            </a>
            <a href="customers.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="users" class="icon"></i
              ></span>
              <span class="nav-item-text">Customers</span>
            </a>
            <a href="categories.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="tag" class="icon"></i
              ></span>
              <span class="nav-item-text">Categories</span>
            </a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">System</div>
            <a href="settings.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="settings" class="icon"></i
              ></span>
              <span class="nav-item-text">Settings</span>
            </a>
          </div>
        </nav>
        <div class="sidebar-footer">
          <div class="user-profile" onclick="BillMaster.auth.logout()">
            <div class="user-avatar">AD</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Logout</div>
            </div>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <header class="main-header">
          <div class="header-left">
            <button class="sidebar-toggle"><i data-lucide="menu"></i></button>
            <h2 class="page-title">
              <i data-lucide="package" class="icon-lg"></i> Products
            </h2>
          </div>
          <div class="header-right">
            <button class="btn btn-primary" onclick="openProductModal()">
              <i data-lucide="plus" class="icon"></i>
              <span>Add Product</span>
            </button>
          </div>
        </header>

        <div class="page-content">
          <div
            class="glass-card"
            style="padding: var(--space-lg); margin-bottom: var(--space-lg)"
          >
            <div style="display: flex; gap: var(--space-md); flex-wrap: wrap">
              <input
                type="text"
                id="searchInput"
                class="form-input"
                placeholder="Search products..."
                style="max-width: 300px"
              />
              <select
                id="categoryFilter"
                class="form-select"
                style="max-width: 200px"
              >
                <option value="">All Categories</option>
              </select>
              <select
                id="statusFilter"
                class="form-select"
                style="max-width: 150px"
              >
                <option value="">All Status</option>
                <option value="1">Active</option>
                <option value="0">Inactive</option>
              </select>
            </div>
          </div>

          <div class="glass-card">
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="productsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
      <div class="modal" style="max-width: 550px">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">Add Product</h3>
          <button
            class="modal-close"
            onclick="BillMaster.modal.close('productModal')"
          >
            <i data-lucide="x"></i>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="productId" />
          <div class="form-group">
            <label class="form-label">Product Name *</label>
            <input
              type="text"
              id="productName"
              class="form-input"
              placeholder="Enter product name"
            />
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: var(--space-md);
            "
          >
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="productCategory" class="form-select"></select>
            </div>
            <div class="form-group">
              <label class="form-label">Unit</label>
              <select id="productUnit" class="form-select">
                <option value="pcs">Pieces</option>
                <option value="kg">Kilogram</option>
                <option value="g">Gram</option>
                <option value="l">Litre</option>
                <option value="ml">Millilitre</option>
              </select>
            </div>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: var(--space-md);
            "
          >
            <div class="form-group">
              <label class="form-label">Price *</label>
              <input
                type="number"
                id="productPrice"
                class="form-input"
                placeholder="0.00"
                min="0"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Stock Quantity</label>
              <input
                type="number"
                id="productStock"
                class="form-input"
                placeholder="0"
                min="0"
              />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea
              id="productDescription"
              class="form-textarea"
              placeholder="Product description (optional)"
              rows="2"
            ></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Image URL</label>
            <input
              type="url"
              id="productImage"
              class="form-input"
              placeholder="https://example.com/image.jpg"
            />
          </div>
          <div class="form-group">
            <label
              style="
                display: flex;
                align-items: center;
                gap: var(--space-sm);
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="productActive"
                class="form-checkbox"
                checked
              />
              <span class="form-label" style="margin: 0">Active</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="BillMaster.modal.close('productModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveProduct()">
            Save Product
          </button>
        </div>
      </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
      let products = [],
        categories = [];

      document.addEventListener("DOMContentLoaded", async () => {
        await BillMaster.auth.requireAuth();
        await initUserInfo();
        lucide.createIcons();
        await loadData();
        initFilters();
      });

      async function loadData() {
        const [catRes, prodRes] = await Promise.all([
          BillMaster.api.get("categories.php?action=list"),
          BillMaster.api.get("products.php?action=list"),
        ]);

        if (catRes.success) {
          categories = catRes.data;
          populateCategoryDropdowns();
        }
        if (prodRes.success) {
          products = prodRes.data;
          renderProducts();
        }
        lucide.createIcons();
      }

      function populateCategoryDropdowns() {
        const filter = document.getElementById("categoryFilter");
        const modal = document.getElementById("productCategory");

        filter.innerHTML =
          '<option value="">All Categories</option>' +
          categories
            .map(
              (c) =>
                `<option value="${c.id}">${BillMaster.utils.escapeHtml(c.name)}</option>`,
            )
            .join("");
        modal.innerHTML =
          '<option value="">No Category</option>' +
          categories
            .map(
              (c) =>
                `<option value="${c.id}">${BillMaster.utils.escapeHtml(c.name)}</option>`,
            )
            .join("");
      }

      function initFilters() {
        document
          .getElementById("searchInput")
          .addEventListener(
            "input",
            BillMaster.utils.debounce(renderProducts, 200),
          );
        document
          .getElementById("categoryFilter")
          .addEventListener("change", renderProducts);
        document
          .getElementById("statusFilter")
          .addEventListener("change", renderProducts);
      }

      function renderProducts() {
        const search = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const catId = document.getElementById("categoryFilter").value;
        const status = document.getElementById("statusFilter").value;

        const filtered = products.filter((p) => {
          if (search && !p.name.toLowerCase().includes(search)) return false;
          if (catId && p.category_id != catId) return false;
          if (status !== "" && p.is_active != status) return false;
          return true;
        });

        const tbody = document.getElementById("productsTable");
        if (!filtered.length) {
          tbody.innerHTML =
            '<tr><td colspan="6" class="empty-state">No products found</td></tr>';
          return;
        }

        tbody.innerHTML = filtered
          .map(
            (p) => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <div style="width: 40px; height: 40px; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                ${p.image_url ? `<img src="${p.image_url}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">` : ""}
                                <i data-lucide="package" class="icon" style="${p.image_url ? "display:none" : ""}"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">${BillMaster.utils.escapeHtml(p.name)}</div>
                                ${p.description ? `<div style="font-size: 0.75rem; color: var(--text-muted);">${BillMaster.utils.escapeHtml(p.description.substring(0, 40))}...</div>` : ""}
                            </div>
                        </div>
                    </td>
                    <td><span class="badge badge-info">${p.category_name || "None"}</span></td>
                    <td style="font-weight: 700; color: var(--success);">${BillMaster.utils.formatCurrency(p.price)}</td>
                    <td>
                        <span class="badge ${p.stock_quantity <= 5 ? "badge-warning" : p.stock_quantity <= 0 ? "badge-danger" : "badge-success"}">
                            ${p.stock_quantity} ${p.unit}
                        </span>
                    </td>
                    <td><span class="badge ${p.is_active == 1 ? "badge-success" : "badge-danger"}">${p.is_active == 1 ? "Active" : "Inactive"}</span></td>
                    <td>
                        <button class="btn btn-sm btn-ghost" onclick="editProduct(${p.id})" title="Edit"><i data-lucide="edit-3" class="icon-sm"></i></button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteProduct(${p.id})" title="Delete"><i data-lucide="trash-2" class="icon-sm"></i></button>
                    </td>
                </tr>
            `,
          )
          .join("");
        lucide.createIcons();
      }

      function openProductModal(product = null) {
        document.getElementById("modalTitle").textContent = product
          ? "Edit Product"
          : "Add Product";
        document.getElementById("productId").value = product?.id || "";
        document.getElementById("productName").value = product?.name || "";
        document.getElementById("productCategory").value =
          product?.category_id || "";
        document.getElementById("productUnit").value = product?.unit || "pcs";
        document.getElementById("productPrice").value = product?.price || "";
        document.getElementById("productStock").value =
          product?.stock_quantity || "0";
        document.getElementById("productDescription").value =
          product?.description || "";
        document.getElementById("productImage").value =
          product?.image_url || "";
        document.getElementById("productActive").checked = product
          ? product.is_active == 1
          : true;
        BillMaster.modal.open("productModal");
      }

      function editProduct(id) {
        const product = products.find((p) => p.id == id);
        if (product) openProductModal(product);
      }

      async function saveProduct() {
        const id = document.getElementById("productId").value;
        const data = {
          name: document.getElementById("productName").value.trim(),
          category_id: document.getElementById("productCategory").value || null,
          unit: document.getElementById("productUnit").value,
          price: parseFloat(document.getElementById("productPrice").value) || 0,
          stock_quantity:
            parseInt(document.getElementById("productStock").value) || 0,
          description: document
            .getElementById("productDescription")
            .value.trim(),
          image_url: document.getElementById("productImage").value.trim(),
          is_active: document.getElementById("productActive").checked ? 1 : 0,
        };

        if (!data.name) {
          BillMaster.toast.error("Product name is required");
          return;
        }
        if (data.price <= 0) {
          BillMaster.toast.error("Price must be greater than 0");
          return;
        }

        const action = id ? "update" : "create";
        if (id) data.id = id;

        const result = await BillMaster.api.post(
          `products.php?action=${action}`,
          data,
        );
        if (result.success) {
          BillMaster.toast.success(
            id ? "Product updated!" : "Product created!",
          );
          BillMaster.modal.close("productModal");
          loadData();
        } else {
          BillMaster.toast.error(result.message || "Failed to save product");
        }
      }

      async function deleteProduct(id) {
        if (!confirm("Are you sure you want to delete this product?")) return;

        const result = await BillMaster.api.get(
          `products.php?action=delete&id=${id}`,
        );
        if (result.success) {
          BillMaster.toast.success("Product deleted!");
          loadData();
        } else {
          BillMaster.toast.error(result.message || "Failed to delete product");
        }
      }
    </script>
  </body>
</html>
