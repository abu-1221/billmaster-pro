<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="BillMaster Pro - Settings" />
    <title>Settings | BillMaster Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/layout.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body>
    <div class="app-layout">
      <div class="mobile-overlay"></div>

      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-logo"><i data-lucide="briefcase"></i></div>
          <div class="sidebar-brand">
            <h1>BillMaster</h1>
            <span>Pro Billing</span>
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">Menu</div>
            <a href="dashboard.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="layout-dashboard" class="icon"></i
              ></span>
              <span class="nav-item-text">Dashboard</span>
            </a>
            <a href="billing.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="receipt" class="icon"></i
              ></span>
              <span class="nav-item-text">New Bill</span>
            </a>
            <a href="invoices.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="file-text" class="icon"></i
              ></span>
              <span class="nav-item-text">Invoices</span>
            </a>
            <a href="expenses.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="credit-card" class="icon"></i
              ></span>
              <span class="nav-item-text">Expenses</span>
            </a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">Manage</div>
            <a href="products.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="package" class="icon"></i
              ></span>
              <span class="nav-item-text">Products</span>
            </a>
            <a href="customers.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="users" class="icon"></i
              ></span>
              <span class="nav-item-text">Customers</span>
            </a>
            <a href="categories.html" class="nav-item">
              <span class="nav-item-icon"
                ><i data-lucide="tag" class="icon"></i
              ></span>
              <span class="nav-item-text">Categories</span>
            </a>
          </div>
          <div class="nav-section">
            <div class="nav-section-title">System</div>
            <a href="settings.html" class="nav-item active">
              <span class="nav-item-icon"
                ><i data-lucide="settings" class="icon"></i
              ></span>
              <span class="nav-item-text">Settings</span>
            </a>
          </div>
        </nav>
        <div class="sidebar-footer">
          <div class="user-profile" onclick="BillMaster.auth.logout()">
            <div class="user-avatar">AD</div>
            <div class="user-info">
              <div class="user-name">Admin</div>
              <div class="user-role">Logout</div>
            </div>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <header class="main-header">
          <div class="header-left">
            <button class="sidebar-toggle"><i data-lucide="menu"></i></button>
            <h2 class="page-title">
              <i data-lucide="settings" class="icon-lg"></i> Settings
            </h2>
          </div>
        </header>

        <div class="page-content">
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
              gap: var(--space-xl);
            "
          >
            <!-- Business Info -->
            <div class="glass-card" style="padding: var(--space-lg)">
              <h3
                style="
                  margin-bottom: var(--space-lg);
                  display: flex;
                  align-items: center;
                  gap: var(--space-sm);
                "
              >
                <i data-lucide="building-2" class="icon"></i> Business
                Information
              </h3>
              <form id="businessForm">
                <div class="form-group">
                  <label class="form-label">Business Name</label>
                  <input
                    type="text"
                    id="businessName"
                    class="form-input"
                    placeholder="Your business name"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Address</label>
                  <textarea
                    id="businessAddress"
                    class="form-textarea"
                    placeholder="Business address"
                  ></textarea>
                </div>
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input
                    type="tel"
                    id="businessPhone"
                    class="form-input"
                    placeholder="Contact phone"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    id="businessEmail"
                    class="form-input"
                    placeholder="Business email"
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i data-lucide="save" class="icon"></i> Save Business Info
                </button>
              </form>
            </div>

            <!-- Billing Settings -->
            <div class="glass-card" style="padding: var(--space-lg)">
              <h3
                style="
                  margin-bottom: var(--space-lg);
                  display: flex;
                  align-items: center;
                  gap: var(--space-sm);
                "
              >
                <i data-lucide="receipt" class="icon"></i> Billing Settings
              </h3>
              <form id="billingForm">
                <div class="form-group">
                  <label class="form-label">Currency Symbol</label>
                  <select id="currencySymbol" class="form-select">
                    <option value="₹">₹ - Indian Rupee</option>
                    <option value="$">$ - US Dollar</option>
                    <option value="€">€ - Euro</option>
                    <option value="£">£ - British Pound</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Tax Rate (%)</label>
                  <input
                    type="number"
                    id="taxRate"
                    class="form-input"
                    placeholder="0"
                    min="0"
                    max="100"
                    step="0.1"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Invoice Prefix</label>
                  <input
                    type="text"
                    id="invoicePrefix"
                    class="form-input"
                    placeholder="INV"
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i data-lucide="save" class="icon"></i> Save Billing Settings
                </button>
              </form>
            </div>
          </div>

          <!-- User Management -->
          <div
            class="glass-card"
            style="padding: var(--space-lg); margin-top: var(--space-xl)"
            id="userSection"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--space-lg);
              "
            >
              <h3
                style="display: flex; align-items: center; gap: var(--space-sm)"
              >
                <i data-lucide="users" class="icon"></i> User Management
              </h3>
              <button class="btn btn-primary btn-sm" onclick="openUserModal()">
                <i data-lucide="user-plus" class="icon"></i> Add User
              </button>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTable"></tbody>
              </table>
            </div>
          </div>

          <!-- Advanced Settings -->
          <div
            class="glass-card"
            style="
              padding: var(--space-lg);
              margin-top: var(--space-xl);
              border: 1px solid rgba(255, 0, 0, 0.2);
            "
          >
            <h3
              style="
                margin-bottom: var(--space-lg);
                display: flex;
                align-items: center;
                gap: var(--space-sm);
                color: #ff4444;
              "
            >
              <i data-lucide="alert-triangle" class="icon"></i> Master Clean &
              Reset
            </h3>

            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: var(--space-lg);
              "
            >
              <!-- Option 1: Browser Cache -->
              <div
                style="
                  padding: var(--space-md);
                  background: rgba(255, 0, 0, 0.05);
                  border-radius: var(--radius-md);
                "
              >
                <h4 style="color: #ff4444; margin-bottom: var(--space-xs)">
                  1. Clear Browser Cache
                </h4>
                <p
                  style="
                    font-size: 0.8125rem;
                    color: var(--text-secondary);
                    margin-bottom: var(--space-md);
                  "
                >
                  Removes "ghost" data from the old version. Use this if the UI
                  looks wrong.
                </p>
                <button
                  onclick="clearFrontendCache()"
                  class="btn btn-secondary btn-sm"
                  style="border-color: #ff4444; color: #ff4444; width: 100%"
                >
                  <i data-lucide="refresh-cw" class="icon"></i> Clear Browser
                  Cache
                </button>
              </div>

              <!-- Option 2: Database Reset -->
              <div
                style="
                  padding: var(--space-md);
                  background: rgba(255, 0, 0, 0.05);
                  border-radius: var(--radius-md);
                "
              >
                <h4 style="color: #ff4444; margin-bottom: var(--space-xs)">
                  2. Factory Reset (Database)
                </h4>
                <p
                  style="
                    font-size: 0.8125rem;
                    color: var(--text-secondary);
                    margin-bottom: var(--space-md);
                  "
                >
                  Wipes all products, sales, and customers from SQL.
                  <strong>Start from scratch.</strong>
                </p>
                <button
                  onclick="factoryResetDatabase()"
                  class="btn btn-secondary btn-sm"
                  style="
                    background: #ff4444;
                    color: white;
                    border: none;
                    width: 100%;
                  "
                >
                  <i data-lucide="bomb" class="icon"></i> Reset Everything (SQL)
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- User Modal -->
    <div class="modal-overlay" id="userModal">
      <div class="modal" style="max-width: 450px">
        <div class="modal-header">
          <h3 class="modal-title">Add User</h3>
          <button
            class="modal-close"
            onclick="BillMaster.modal.close('userModal')"
          >
            <i data-lucide="x"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Full Name *</label>
            <input
              type="text"
              id="userFullName"
              class="form-input"
              placeholder="Enter full name"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Username *</label>
            <input
              type="text"
              id="userUsername"
              class="form-input"
              placeholder="Enter username"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Password *</label>
            <input
              type="password"
              id="userPassword"
              class="form-input"
              placeholder="Min 6 characters"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select id="userRole" class="form-select">
              <option value="staff">Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="BillMaster.modal.close('userModal')"
          >
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveUser()">
            Create User
          </button>
        </div>
      </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        await BillMaster.auth.requireAuth();
        await initUserInfo();
        lucide.createIcons();
        await loadSettings();
        await loadUsers();
      });

      async function loadSettings() {
        const result = await BillMaster.api.get("settings.php?action=get");
        if (result.success && result.data) {
          document.getElementById("businessName").value =
            result.data.business_name || "";
          document.getElementById("businessAddress").value =
            result.data.business_address || "";
          document.getElementById("businessPhone").value =
            result.data.business_phone || "";
          document.getElementById("businessEmail").value =
            result.data.business_email || "";
          document.getElementById("currencySymbol").value =
            result.data.currency_symbol || "₹";
          document.getElementById("taxRate").value =
            result.data.tax_rate || "0";
          document.getElementById("invoicePrefix").value =
            result.data.invoice_prefix || "INV";
        }
      }

      document
        .getElementById("businessForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            business_name: document.getElementById("businessName").value.trim(),
            business_address: document
              .getElementById("businessAddress")
              .value.trim(),
            business_phone: document
              .getElementById("businessPhone")
              .value.trim(),
            business_email: document
              .getElementById("businessEmail")
              .value.trim(),
          };

          const result = await BillMaster.api.post(
            "settings.php?action=update",
            data,
          );
          if (result.success) BillMaster.toast.success("Business info saved!");
          else BillMaster.toast.error(result.message || "Failed to save");
        });

      document
        .getElementById("billingForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            currency_symbol: document.getElementById("currencySymbol").value,
            tax_rate: document.getElementById("taxRate").value,
            invoice_prefix: document
              .getElementById("invoicePrefix")
              .value.trim(),
          };

          const result = await BillMaster.api.post(
            "settings.php?action=update",
            data,
          );
          if (result.success)
            BillMaster.toast.success("Billing settings saved!");
          else BillMaster.toast.error(result.message || "Failed to save");
        });

      async function loadUsers() {
        const result = await BillMaster.api.get("settings.php?action=users");
        if (!result.success) {
          document.getElementById("userSection").style.display = "none";
          return;
        }

        const tbody = document.getElementById("usersTable");
        tbody.innerHTML = result.data
          .map(
            (user) => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: var(--space-md);">
                            <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.75rem;">
                                ${BillMaster.utils.getInitials(user.full_name)}
                            </div>
                            <span style="font-weight: 500;">${BillMaster.utils.escapeHtml(user.full_name)}</span>
                        </div>
                    </td>
                    <td><code style="background: var(--bg-tertiary); padding: 0.125rem 0.5rem; border-radius: var(--radius-sm);">${user.username}</code></td>
                    <td><span class="badge ${user.role === "admin" ? "badge-primary" : "badge-info"}">${user.role}</span></td>
                    <td style="font-size: 0.875rem; color: var(--text-muted);">${BillMaster.utils.formatDate(user.created_at)}</td>
                    <td>
                      <div style="display: flex; gap: 4px;">
                        <button class="btn btn-sm btn-ghost" onclick="promptPassword(${user.id})" title="Change Password"><i data-lucide="key" class="icon-sm"></i></button>
                        ${user.id > 1 ? `<button class="btn btn-sm btn-ghost" onclick="deleteUser(${user.id})" title="Delete User"><i data-lucide="trash-2" class="icon-sm"></i></button>` : ""}
                      </div>
                    </td>
                </tr>
            `,
          )
          .join("");
        lucide.createIcons();
      }

      async function promptPassword(id) {
        const newPass = prompt("Enter new password for this user:");
        if (!newPass) return;
        if (newPass.length < 6) {
          BillMaster.toast.error("Password too short");
          return;
        }

        const result = await BillMaster.api.post(
          "auth.php?action=update_password",
          {
            id: id,
            password: newPass,
          },
        );
        if (result.success) BillMaster.toast.success("Password updated!");
        else BillMaster.toast.error(result.message || "Failed to update");
      }

      function openUserModal() {
        document.getElementById("userFullName").value = "";
        document.getElementById("userUsername").value = "";
        document.getElementById("userPassword").value = "";
        document.getElementById("userRole").value = "staff";
        BillMaster.modal.open("userModal");
      }

      async function saveUser() {
        const data = {
          full_name: document.getElementById("userFullName").value.trim(),
          username: document.getElementById("userUsername").value.trim(),
          password: document.getElementById("userPassword").value,
          role: document.getElementById("userRole").value,
        };

        if (!data.full_name || !data.username || !data.password) {
          BillMaster.toast.error("Please fill all required fields");
          return;
        }
        if (data.password.length < 6) {
          BillMaster.toast.error("Password must be at least 6 characters");
          return;
        }

        const result = await BillMaster.api.post(
          "auth.php?action=register",
          data,
        );
        if (result.success) {
          BillMaster.toast.success("User created!");
          BillMaster.modal.close("userModal");
          loadUsers();
        } else {
          BillMaster.toast.error(result.message || "Failed to create user");
        }
      }

      async function deleteUser(id) {
        if (!confirm("Delete this user?")) return;

        const result = await BillMaster.api.get(
          `settings.php?action=delete_user&id=${id}`,
        );
        if (result.success) {
          BillMaster.toast.success("User deleted!");
          loadUsers();
        } else {
          BillMaster.toast.error(result.message || "Failed to delete");
        }
      }

      function clearFrontendCache() {
        if (
          confirm(
            "Are you sure? This will clear all browser cache and log you out. The SQL database will NOT be affected.",
          )
        ) {
          localStorage.clear();
          window.location.replace("login.html");
        }
      }

      async function factoryResetDatabase() {
        if (
          confirm(
            "ATTENTION: This will permanently delete ALL products, customers, and sales history from the SQL database. This cannot be undone. Proceed?",
          )
        ) {
          const result = await BillMaster.api.get(
            "settings.php?action=factory_reset",
          );
          if (result.success) {
            localStorage.clear();
            alert("Database wiped successfully! Application will now refresh.");
            window.location.replace("login.html");
          } else {
            BillMaster.toast.error(result.message || "Reset failed");
          }
        }
      }
    </script>
  </body>
</html>
